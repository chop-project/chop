# [CVE-2009-4009](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-4009)

## Vulnerable Code Path

[CVE-2009-4009](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-4009) is a textbook example for CHOP. The vulnerability resides in the [`questionExpand` function of PowerDNS](https://github.com/PowerDNS/pdns/blob/rec-3.1.7.2/pdns/pdns_recursor.cc#L810-L839):

```C
void questionExpand(const char* packet, uint16_t len, char* qname, int maxlen, uint16_t& type)
{
  type=0;
  const unsigned char* end=(const unsigned char*)packet+len;
  unsigned char* lbegin=(unsigned char*)packet+12;
  unsigned char* pos=lbegin;
  unsigned char labellen;

  // 3www4ds9a2nl0
  char *dst=qname;
  char* lend=dst + maxlen;

  /* ... */
  while((labellen=*pos++) && pos < end) {
    if(dst >= lend)
      throw runtime_error("Label length exceeded destination length");
    for(;labellen;--labellen)
      *dst++ = *pos++;
    *dst++='.';
  }
  /* ... */
}
```

The main issue is that the check whether more data were written than the buffer can hold is performed *after* the data were already written, and if so, an exception is thrown; an ideal entry-point for a CHOP attack.


## Running the PoC

Build and run a vulnerable version of the PowerDNS recursor:

```sh
docker build -t chop-cve-2009-4009 .
docker run --rm -it \
    --security-opt seccomp=$(pwd)/allow-personality-no-aslr.json \
    --name chop-cve-2009-4009 \
    chop-cve-2009-4009
```

Then, in a separate terminal, run the exploit:

```sh
docker exec chop-cve-2009-4009 exploit.py
```

## Acknowledgements

We would like to thank Gregor Kopf for pointing out this vulnerability to us.
