# docker build -t chop-cve-2009-4009 .
# docker run --rm -it \
#    --security-opt seccomp=$(pwd)/allow-personality-no-aslr.json \
#    --name chop-cve-2009-4009
#    chop-cve-2009-4009
# then, run the exploit:
# docker exec chop-cve-2009-4009 /cve-2009-4009/exploit.py

# This stage will build a vulnerable version of pdns recursor, and place it in /
FROM debian/eol:lenny as build

ENV DEBIAN_FRONTEND=noninteractive
RUN echo "deb-src http://archive.debian.org/debian lenny main" >> /etc/apt/sources.list
RUN apt-get update
RUN apt-get install -y dpkg-dev
RUN apt-get build-dep -y pdns-recursor && apt-get source pdns-recursor

WORKDIR /pdns-recursor-3.1.7

# Add some bugs
RUN sed -i 's/CVE-2009-4009/# CVE-2009-4009/g' debian/patches/00list
RUN sed -i 's/CVE-2009-4010/# CVE-2009-4010/g' debian/patches/00list

# Enable stack canaries
RUN sed -i 's/CXXFLAGS = -Wall -g/CXXFLAGS = -Wall -g -fstack-protector/g' debian/rules
RUN sed -i 's/CFLAGS = -Wall -g/CFLAGS = -Wall -g -fstack-protector/g' debian/rules
ENV DEB_BUILD_OPTIONS='noopt debug nostrip'
RUN dpkg-buildpackage || true # Returns non zero
RUN cp ./debian/pdns-recursor/usr/sbin/pdns_recursor /

WORKDIR /

FROM ubuntu:20.04
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get -y install python3 python3-pip
RUN pip3 install pwn dnslib

COPY --chmod=0755 --from=build /pdns_recursor /usr/sbin/
ADD recursor.conf /etc/powerdns/recursor.conf
ADD --chmod=0755 ./exploit.py /usr/bin
ADD libc.so.6 /usr/lib/x86_64-linux-gnu/libc-2.31.so
ADD libstdc++.so.6 /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.28

# Make pwntools happy
ENV PWNLIB_NOTERM=1

ENTRYPOINT ["setarch", "x86_64", "-R", "pdns_recursor"]
