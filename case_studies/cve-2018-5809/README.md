# [CVE-2018-5809]

## The bug

[CVE-2018-5809] was fixed in [LibRaw commit `fd63302`](https://github.com/LibRaw/LibRaw/commit/fd6330292501983ac75fe4162275794b18445bd9).

This is [the vulnerable codepath](https://github.com/LibRaw/LibRaw/blob/5161244b5dde388ec8f99ec4d695cda4dafd07b6/dcraw/dcraw.c#L11079-L11090), an attacker-controlled amount of bytes are read from the makernotes exif tag into the stack-based buffer `mn_text` for specific Raspberry Pi raw images:

```c
  while (entries--) {
    tiff_get (base, &tag, &type, &len, &save);
    // ...
    switch(tag) {
      // ...
      case 37500:  	                         // tag 0x927c
#ifdef LIBRAW_LIBRARY_BUILD
       if (((make[0] == '\0') && (!strncmp(model, "ov5647",6))) ||
           ((!strncmp(make, "RaspberryPi",11)) && (!strncmp(model, "RP_OV5647",9))) ||
           ((!strncmp(make, "RaspberryPi",11)) && (!strncmp(model, "RP_imx219",9)))) {
         char mn_text[512];
         /// ...
         fgets(mn_text, len, ifp);
         /// ...
       }
       else
#endif
        parse_makernote (base, 0);
    }
  }
```

A throw statement is not directly reachable in the RaspberryPi makernote code path, however for other make/model combinations, an error in the parsing of the makernote can cause an exception to be thrown in `parse_makernote`.

[CVE-2018-5809]: https://nvd.nist.gov/vuln/detail/CVE-2018-5809

## LibRaw

We're targeting LibRaw through the `raw-identify` binary.

## The exploit

Trigger the stack buffer overflow, overwriting the make in of the image farther up the stack, so we can trigger a throw in a subsequent iteration of `parse_exif`, parsing a fake nikon makernote.

We then target a [pivot2rop handler](https://github.com/LibRaw/LibRaw/blob/5161244b5dde388ec8f99ec4d695cda4dafd07b6/src/libraw_cxx.cpp#L5701-L5704), and overwrite the return address to a libc [one_gadget] address.

ASLR is disabled using the `setarch` command, and load addresses are calculated using `ldd`. This requires the `personality` syscall with the `ADDR_NO_RANDOMIZE` (`0x40000`) parameter, which is blocked by the [default docker seccomp ruleset]. The provided [seccomp ruleset](./allow-personality-no-aslr.json) expands the default docker seccomp ruleset and adds a rule allowing this syscall. The container entrypoint then disables ASLR for all child processes.

[one_gadget]: https://github.com/david942j/one_gadget
[default docker seccomp ruleset]: https://github.com/moby/moby/blob/master/profiles/seccomp/default.json

## Running the POC

```bash
docker build -t chop:cve-2018-5809 .
docker run -it --security-opt seccomp=$(pwd)/allow-personality-no-aslr.json chop:cve-2018-5809
```

```bash
# normal execution
$ ./raw-identify rpi.raw
rpi.raw is a Broadcom RPi IMX219 image.
$ ./demo
# ...
[+] Created Payload Image: pwn.raw
# run the exploit payload
$ ./raw-identify pwn.raw
```
