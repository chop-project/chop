# docker build -t bheu .
# docker run \
#    --security-opt seccomp=$(pwd)/allow-personality-no-aslr.json \
#    bheu
# then:
# ./raw-identify rpi.raw
# ./solve.py
# ./raw-identify pwn.raw

FROM ubuntu:20.04 as build
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get -y install \
    curl build-essential

WORKDIR /solve

ADD crafter/Cargo.toml .
ADD crafter/src ./src

RUN (curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y) && \
    /root/.cargo/bin/cargo build --release && \
    cp target/release/replace_tags . && \
    rm -rf target

FROM ubuntu:20.04

RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get -y install \
    python3 python3-pip \
    libraw-bin libraw-dev

RUN pip3 install pwn

WORKDIR /demo
COPY --from=build /solve/replace_tags /bin/
ADD raw-identify .
ADD libraw.so.16 /lib/x86_64-linux-gnu

RUN pip3 install colorama

ADD crafter/solve.py ./demo
ADD crafter/rpi.raw .

ENTRYPOINT ["setarch", "x86_64", "-R", "bash"]
